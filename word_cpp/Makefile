HERE:=$(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
SIP_BUILD_FILE:=word.sbf
STUB_FILE:=word.pyi
SIP_SPEC_FILE:=sip/word.sip
DIR_GEN_CODE:=generated

CXX = g++
CXXFLAGS = -pipe -fPIC -O2 -Wall -W
VENV:=$(shell pipenv --venv)
CPPFLAGS = -DNDEBUG -I. -I${VENV}/include/python3.6m -I/home/giacomo/miniconda3/include/python3.6m
TARGET = word.so
LINKER_FLAGS = -shared -Wl,--verbose
OBJECT_FILES = sipwordcmodule.o sipwordWord.o

.PHONY: help
help:
	@echo 'help  - Show this help and exit.'
	@echo 'gen   - Generate C/C++ code from a SIP specification file (.sip).'
	@echo '        See docs for SIP command line options:'
	@echo '        http://pyqt.sourceforge.net/Docs/sip4/command_line.html'
	@echo 'clean - Clean files generated by the SIP CLI.'
	@echo ''
	@echo 'You are here: ${HERE}'

.PHONY: gen
gen:
	@echo ${AAA}
	@echo "Build library with SIP version $(shell sip -V)"
	sip \
	  -c ${DIR_GEN_CODE} \
	  -b ${SIP_BUILD_FILE} \
	  -y ${STUB_FILE} \
	  -e \
	  -g \
	  ${SIP_SPEC_FILE}

.PHONY: compile
compile:
	g++ \
	  -c ${DIR_GEN_CODE}/sipwordWord.cpp ${DIR_GEN_CODE}/sipwordcmodule.cpp \
	  $(CXXFLAGS) $(CPPFLAGS)

.PHONY: link
link:
	g++ \
	$(LINKER_FLAGS) \
	$(OBJECT_FILES) \
	-o $(TARGET)

install: $(TARGET)
	cp --force $(TARGET) $(VENV)/lib/python3.6/site-packages/$(TARGET)
	# strip $(DESTDIR)/home/giacomo/.virtualenvs/sip-hello-world-QlxdDS6B/lib/python3.6/site-packages/$(TARGET)

.PHONY: clean
clean:
	rm ${DIR_GEN_CODE}/sipAPIword.h
	rm ${DIR_GEN_CODE}/sipwordWord.cpp
	rm ${DIR_GEN_CODE}/sipwordcmodule.cpp
	rm ${SIP_BUILD_FILE}
	rm ${STUB_FILE}
	rm ${OBJECT_FILES}
	rm ${TARGET}
